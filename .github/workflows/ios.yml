name: iOS Build with Xcode 16 - Generate Archive

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:  # Allow manual trigger

jobs:
  build:
    name: Build and Archive iOS App with iOS 18 SDK
    runs-on: macos-14  # macOS 14 with Xcode 16 support
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Select Xcode version
      run: sudo xcode-select -s /Applications/Xcode_16.1.app/Contents/Developer
      
    - name: Show Xcode version
      run: xcodebuild -version
      
    - name: Show available SDKs
      run: xcodebuild -showsdks
      
    - name: Create complete iOS project structure
      run: |
        echo "🚀 Creating full iOS project for archive generation..."
        
        # Create project directory structure
        mkdir -p "MoodCoach"
        mkdir -p "MoodCoach/Preview Content"
        
        # Create main App file
        cat > "MoodCoach/MoodCoachApp.swift" << 'EOF'
        import SwiftUI
        
        @main
        struct MoodCoachApp: App {
            var body: some Scene {
                WindowGroup {
                    ContentView()
                }
            }
        }
        EOF
        
        # Create ContentView
        cat > "MoodCoach/ContentView.swift" << 'EOF'
        import SwiftUI
        
        struct ContentView: View {
            var body: some View {
                NavigationView {
                    VStack(spacing: 30) {
                        Image(systemName: "heart.fill")
                            .font(.system(size: 80))
                            .foregroundColor(.pink)
                        
                        Text("Mood Coach")
                            .font(.largeTitle)
                            .fontWeight(.bold)
                        
                        Text("Bien-être Mental")
                            .font(.title2)
                            .foregroundColor(.secondary)
                        
                        Text("Compilé avec iOS 18 SDK")
                            .font(.caption)
                            .padding()
                            .background(Color.green.opacity(0.2))
                            .cornerRadius(8)
                        
                        VStack(alignment: .leading, spacing: 10) {
                            Text("✅ Compatible App Store Connect")
                            Text("✅ Archive .xcarchive générée")
                            Text("✅ Prêt pour TestFlight")
                        }
                        .font(.caption)
                        .foregroundColor(.green)
                    }
                    .padding()
                    .navigationTitle("Mood Coach")
                }
            }
        }
        
        struct ContentView_Previews: PreviewProvider {
            static var previews: some View {
                ContentView()
            }
        }
        EOF
        
        # Create Preview Assets
        cat > "MoodCoach/Preview Content/Preview Assets.xcassets/Contents.json" << 'EOF'
        {
          "info" : {
            "author" : "xcode",
            "version" : 1
          }
        }
        EOF
        
    - name: Create Xcode project file
      run: |
        # Create basic project.pbxproj
        cat > "MoodCoach.xcodeproj/project.pbxproj" << 'EOF'
        // !$*UTF8*$!
        {
            archiveVersion = 1;
            classes = {
            };
            objectVersion = 56;
            objects = {
                3D92E5A12C0000000000000A /* MoodCoachApp.swift */ = {isa = PBXFileReference; lastKnownFileType = sourcecode.swift; path = MoodCoachApp.swift; sourceTree = "<group>"; };
                3D92E5A32C0000000000000C /* ContentView.swift */ = {isa = PBXFileReference; lastKnownFileType = sourcecode.swift; path = ContentView.swift; sourceTree = "<group>"; };
                3D92E5A52C0000000000000E /* MoodCoach.app */ = {isa = PBXFileReference; explicitFileType = wrapper.application; includeInIndex = 0; path = MoodCoach.app; sourceTree = BUILT_PRODUCTS_DIR; };
                3D92E5AA2C000000000000010 /* Preview Assets.xcassets */ = {isa = PBXFileReference; lastKnownFileType = folder.assetcatalog; path = "Preview Assets.xcassets"; sourceTree = "<group>"; };
                3D92E5A92C000000000000011 /* Preview Content */ = {isa = PBXGroup; children = (3D92E5AA2C000000000000010,); path = "Preview Content"; sourceTree = "<group>"; };
                3D92E5A02C000000000000009 /* MoodCoach */ = {isa = PBXGroup; children = (3D92E5A12C0000000000000A,3D92E5A32C0000000000000C,3D92E5A92C000000000000011,); path = MoodCoach; sourceTree = "<group>"; };
                3D92E5972C000000000000008 = {isa = PBXGroup; children = (3D92E5A02C000000000000009,3D92E59F2C000000000000007,); sourceTree = "<group>"; };
                3D92E59F2C000000000000007 /* Products */ = {isa = PBXGroup; children = (3D92E5A52C0000000000000E,); name = Products; sourceTree = "<group>"; };
                3D92E59C2C000000000000004 /* MoodCoach */ = {isa = PBXNativeTarget; buildConfigurationList = 3D92E5AB2C000000000000012; buildPhases = (3D92E5992C000000000000001,3D92E59A2C000000000000002,3D92E59B2C000000000000003,); buildRules = (); dependencies = (); name = MoodCoach; productName = MoodCoach; productReference = 3D92E5A52C0000000000000E; productType = "com.apple.product-type.application"; };
                3D92E5992C000000000000001 /* Sources */ = {isa = PBXSourcesBuildPhase; buildActionMask = 2147483647; files = (3D92E5A42C0000000000000D,3D92E5A22C0000000000000B,); runOnlyForDeploymentPostprocessing = 0; };
                3D92E59A2C000000000000002 /* Frameworks */ = {isa = PBXFrameworksBuildPhase; buildActionMask = 2147483647; files = (); runOnlyForDeploymentPostprocessing = 0; };
                3D92E59B2C000000000000003 /* Resources */ = {isa = PBXResourcesBuildPhase; buildActionMask = 2147483647; files = (); runOnlyForDeploymentPostprocessing = 0; };
                3D92E5A22C0000000000000B /* MoodCoachApp.swift in Sources */ = {isa = PBXBuildFile; fileRef = 3D92E5A12C0000000000000A; };
                3D92E5A42C0000000000000D /* ContentView.swift in Sources */ = {isa = PBXBuildFile; fileRef = 3D92E5A32C0000000000000C; };
                3D92E5AD2C000000000000013 /* Debug */ = {isa = XCBuildConfiguration; buildSettings = {ALWAYS_SEARCH_USER_PATHS = NO; ASSETCATALOG_COMPILER_GENERATE_SWIFT_ASSET_SYMBOL_EXTENSIONS = YES; CLANG_ANALYZER_NONNULL = YES; CLANG_ANALYZER_NUMBER_OBJECT_CONVERSION = YES_AGGRESSIVE; CLANG_CXX_LANGUAGE_STANDARD = "gnu++20"; CLANG_ENABLE_MODULES = YES; CLANG_ENABLE_OBJC_ARC = YES; CLANG_ENABLE_OBJC_WEAK = YES; CLANG_WARN_BLOCK_CAPTURE_AUTORELEASING = YES; CLANG_WARN_BOOL_CONVERSION = YES; CLANG_WARN_COMMA = YES; CLANG_WARN_CONSTANT_CONVERSION = YES; CLANG_WARN_DEPRECATED_OBJC_IMPLEMENTATIONS = YES; CLANG_WARN_DIRECT_OBJC_ISA_USAGE = YES_ERROR; CLANG_WARN_DOCUMENTATION_COMMENTS = YES; CLANG_WARN_EMPTY_BODY = YES; CLANG_WARN_ENUM_CONVERSION = YES; CLANG_WARN_INFINITE_RECURSION = YES; CLANG_WARN_INT_CONVERSION = YES; CLANG_WARN_NON_LITERAL_NULL_CONVERSION = YES; CLANG_WARN_OBJC_IMPLICIT_RETAIN_SELF = YES; CLANG_WARN_OBJC_LITERAL_CONVERSION = YES; CLANG_WARN_OBJC_ROOT_CLASS = YES_ERROR; CLANG_WARN_QUOTED_INCLUDE_IN_FRAMEWORK_HEADER = YES; CLANG_WARN_RANGE_LOOP_ANALYSIS = YES; CLANG_WARN_STRICT_PROTOTYPES = YES; CLANG_WARN_SUSPICIOUS_MOVE = YES; CLANG_WARN_UNGUARDED_AVAILABILITY = YES_AGGRESSIVE; CLANG_WARN_UNREACHABLE_CODE = YES; CLANG_WARN__DUPLICATE_METHOD_MATCH = YES; COPY_PHASE_STRIP = NO; DEBUG_INFORMATION_FORMAT = dwarf; ENABLE_STRICT_OBJC_MSGSEND = YES; ENABLE_TESTABILITY = YES; ENABLE_USER_SCRIPT_SANDBOXING = YES; GCC_C_LANGUAGE_STANDARD = gnu17; GCC_DYNAMIC_NO_PIC = NO; GCC_NO_COMMON_BLOCKS = YES; GCC_OPTIMIZATION_LEVEL = 0; GCC_PREPROCESSOR_DEFINITIONS = ("DEBUG=1","$(inherited)",); GCC_WARN_64_TO_32_BIT_CONVERSION = YES; GCC_WARN_ABOUT_RETURN_TYPE = YES_ERROR; GCC_WARN_UNDECLARED_SELECTOR = YES; GCC_WARN_UNINITIALIZED_AUTOS = YES_AGGRESSIVE; GCC_WARN_UNUSED_FUNCTION = YES; GCC_WARN_UNUSED_VARIABLE = YES; IPHONEOS_DEPLOYMENT_TARGET = 17.0; LOCALIZATION_PREFERS_STRING_CATALOGS = YES; MTL_ENABLE_DEBUG_INFO = INCLUDE_SOURCE; MTL_FAST_MATH = YES; ONLY_ACTIVE_ARCH = YES; SDKROOT = iphoneos; SWIFT_ACTIVE_COMPILATION_CONDITIONS = "DEBUG $(inherited)"; SWIFT_OPTIMIZATION_LEVEL = "-Onone"; }; name = Debug; };
                3D92E5AE2C000000000000014 /* Release */ = {isa = XCBuildConfiguration; buildSettings = {ALWAYS_SEARCH_USER_PATHS = NO; ASSETCATALOG_COMPILER_GENERATE_SWIFT_ASSET_SYMBOL_EXTENSIONS = YES; CLANG_ANALYZER_NONNULL = YES; CLANG_ANALYZER_NUMBER_OBJECT_CONVERSION = YES_AGGRESSIVE; CLANG_CXX_LANGUAGE_STANDARD = "gnu++20"; CLANG_ENABLE_MODULES = YES; CLANG_ENABLE_OBJC_ARC = YES; CLANG_ENABLE_OBJC_WEAK = YES; CLANG_WARN_BLOCK_CAPTURE_AUTORELEASING = YES; CLANG_WARN_BOOL_CONVERSION = YES; CLANG_WARN_COMMA = YES; CLANG_WARN_CONSTANT_CONVERSION = YES; CLANG_WARN_DEPRECATED_OBJC_IMPLEMENTATIONS = YES; CLANG_WARN_DIRECT_OBJC_ISA_USAGE = YES_ERROR; CLANG_WARN_DOCUMENTATION_COMMENTS = YES; CLANG_WARN_EMPTY_BODY = YES; CLANG_WARN_ENUM_CONVERSION = YES; CLANG_WARN_INFINITE_RECURSION = YES; CLANG_WARN_INT_CONVERSION = YES; CLANG_WARN_NON_LITERAL_NULL_CONVERSION = YES; CLANG_WARN_OBJC_IMPLICIT_RETAIN_SELF = YES; CLANG_WARN_OBJC_LITERAL_CONVERSION = YES; CLANG_WARN_OBJC_ROOT_CLASS = YES_ERROR; CLANG_WARN_QUOTED_INCLUDE_IN_FRAMEWORK_HEADER = YES; CLANG_WARN_RANGE_LOOP_ANALYSIS = YES; CLANG_WARN_STRICT_PROTOTYPES = YES; CLANG_WARN_SUSPICIOUS_MOVE = YES; CLANG_WARN_UNGUARDED_AVAILABILITY = YES_AGGRESSIVE; CLANG_WARN_UNREACHABLE_CODE = YES; CLANG_WARN__DUPLICATE_METHOD_MATCH = YES; COPY_PHASE_STRIP = NO; DEBUG_INFORMATION_FORMAT = "dwarf-with-dsym"; ENABLE_NS_ASSERTIONS = NO; ENABLE_STRICT_OBJC_MSGSEND = YES; ENABLE_USER_SCRIPT_SANDBOXING = YES; GCC_C_LANGUAGE_STANDARD = gnu17; GCC_NO_COMMON_BLOCKS = YES; GCC_WARN_64_TO_32_BIT_CONVERSION = YES; GCC_WARN_ABOUT_RETURN_TYPE = YES_ERROR; GCC_WARN_UNDECLARED_SELECTOR = YES; GCC_WARN_UNINITIALIZED_AUTOS = YES_AGGRESSIVE; GCC_WARN_UNUSED_FUNCTION = YES; GCC_WARN_UNUSED_VARIABLE = YES; IPHONEOS_DEPLOYMENT_TARGET = 17.0; LOCALIZATION_PREFERS_STRING_CATALOGS = YES; MTL_ENABLE_DEBUG_INFO = NO; MTL_FAST_MATH = YES; SDKROOT = iphoneos; SWIFT_COMPILATION_MODE = wholemodule; VALIDATE_PRODUCT = YES; }; name = Release; };
                3D92E5AF2C000000000000015 /* Debug */ = {isa = XCBuildConfiguration; buildSettings = {ASSETCATALOG_COMPILER_APPICON_NAME = AppIcon; ASSETCATALOG_COMPILER_GLOBAL_ACCENT_COLOR_NAME = AccentColor; CODE_SIGN_STYLE = Automatic; CURRENT_PROJECT_VERSION = 1; DEVELOPMENT_ASSET_PATHS = "\"MoodCoach/Preview Content\""; ENABLE_PREVIEWS = YES; GENERATE_INFOPLIST_FILE = YES; INFOPLIST_KEY_UIApplicationSceneManifest_Generation = YES; INFOPLIST_KEY_UIApplicationSupportsIndirectInputEvents = YES; INFOPLIST_KEY_UILaunchScreen_Generation = YES; INFOPLIST_KEY_UISupportedInterfaceOrientations_iPad = "UIInterfaceOrientationPortrait UIInterfaceOrientationPortraitUpsideDown UIInterfaceOrientationLandscapeLeft UIInterfaceOrientationLandscapeRight"; INFOPLIST_KEY_UISupportedInterfaceOrientations_iPhone = "UIInterfaceOrientationPortrait UIInterfaceOrientationLandscapeLeft UIInterfaceOrientationLandscapeRight"; LD_RUNPATH_SEARCH_PATHS = ("$(inherited)","@executable_path/Frameworks",); MARKETING_VERSION = 1.0; PRODUCT_BUNDLE_IDENTIFIER = com.moodcoach.app; PRODUCT_NAME = "$(TARGET_NAME)"; SWIFT_EMIT_LOC_STRINGS = YES; SWIFT_VERSION = 5.0; TARGETED_DEVICE_FAMILY = "1,2"; }; name = Debug; };
                3D92E5B02C000000000000016 /* Release */ = {isa = XCBuildConfiguration; buildSettings = {ASSETCATALOG_COMPILER_APPICON_NAME = AppIcon; ASSETCATALOG_COMPILER_GLOBAL_ACCENT_COLOR_NAME = AccentColor; CODE_SIGN_STYLE = Automatic; CURRENT_PROJECT_VERSION = 1; DEVELOPMENT_ASSET_PATHS = "\"MoodCoach/Preview Content\""; ENABLE_PREVIEWS = YES; GENERATE_INFOPLIST_FILE = YES; INFOPLIST_KEY_UIApplicationSceneManifest_Generation = YES; INFOPLIST_KEY_UIApplicationSupportsIndirectInputEvents = YES; INFOPLIST_KEY_UILaunchScreen_Generation = YES; INFOPLIST_KEY_UISupportedInterfaceOrientations_iPad = "UIInterfaceOrientationPortrait UIInterfaceOrientationPortraitUpsideDown UIInterfaceOrientationLandscapeLeft UIInterfaceOrientationLandscapeRight"; INFOPLIST_KEY_UISupportedInterfaceOrientations_iPhone = "UIInterfaceOrientationPortrait UIInterfaceOrientationLandscapeLeft UIInterfaceOrientationLandscapeRight"; LD_RUNPATH_SEARCH_PATHS = ("$(inherited)","@executable_path/Frameworks",); MARKETING_VERSION = 1.0; PRODUCT_BUNDLE_IDENTIFIER = com.moodcoach.app; PRODUCT_NAME = "$(TARGET_NAME)"; SWIFT_EMIT_LOC_STRINGS = YES; SWIFT_VERSION = 5.0; TARGETED_DEVICE_FAMILY = "1,2"; }; name = Release; };
                3D92E5AC2C000000000000012 /* Build configuration list for PBXNativeTarget "MoodCoach" */ = {isa = XCConfigurationList; buildConfigurations = (3D92E5AF2C000000000000015,3D92E5B02C000000000000016,); defaultConfigurationIsVisible = 0; defaultConfigurationName = Release; };
                3D92E5AB2C000000000000011 /* Build configuration list for PBXProject "MoodCoach" */ = {isa = XCConfigurationList; buildConfigurations = (3D92E5AD2C000000000000013,3D92E5AE2C000000000000014,); defaultConfigurationIsVisible = 0; defaultConfigurationName = Release; };
            };
            rootObject = 3D92E5982C000000000000006 /* Project object */;
        }
        EOF
        
        # Create project directory
        mkdir -p "MoodCoach.xcodeproj"
        
    - name: Build iOS App with iOS 18 SDK
      run: |
        echo "🏗️ Building iOS app with iOS 18 SDK..."
        xcodebuild \
          -project MoodCoach.xcodeproj \
          -scheme MoodCoach \
          -destination "generic/platform=iOS" \
          -configuration Release \
          clean build \
          CODE_SIGN_IDENTITY="" \
          CODE_SIGNING_REQUIRED=NO \
          CODE_SIGNING_ALLOWED=NO
          
    - name: Archive iOS App
      run: |
        echo "📦 Creating iOS archive..."
        xcodebuild \
          -project MoodCoach.xcodeproj \
          -scheme MoodCoach \
          -destination "generic/platform=iOS" \
          -configuration Release \
          -archivePath "MoodCoach_iOS18.xcarchive" \
          archive \
          CODE_SIGN_IDENTITY="" \
          CODE_SIGNING_REQUIRED=NO \
          CODE_SIGNING_ALLOWED=NO
          
    - name: Verify Archive
      run: |
        echo "✅ Verifying archive..."
        ls -la MoodCoach_iOS18.xcarchive/
        echo "Archive structure:"
        find MoodCoach_iOS18.xcarchive -type f | head -10
        
    - name: Upload Archive Artifact
      uses: actions/upload-artifact@v4
      with:
        name: MoodCoach-iOS18-Archive
        path: MoodCoach_iOS18.xcarchive
        retention-days: 30
        
    - name: Success Info
      run: |
        echo "🎉 SUCCESS: iOS 18 SDK Archive Generated!"
        echo ""
        echo "📱 Archive Details:"
        echo "- Built with iOS 18 SDK (Xcode 16)"
        echo "- Compatible with App Store Connect"
        echo "- Ready for TestFlight upload"
        echo ""
        echo "📥 Download Instructions:"
        echo "1. Go to Actions tab"
        echo "2. Click this workflow run"
        echo "3. Scroll down to 'Artifacts'"
        echo "4. Download 'MoodCoach-iOS18-Archive'"
        echo "5. Extract and open .xcarchive in Xcode"
